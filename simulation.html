<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Fire Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
            overflow-y: auto;
            gap: 15px;
        }

        canvas {
            border: 2px solid #555;
            background-color: #000;
            image-rendering: pixelated;
            max-width: 95vw;
            height: auto;
            display: block;
        }

        button {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 4px;
            width: 90%;
            max-width: 400px;
            font-size: 1rem;
        }

        button:hover {
            background: #555;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 90%;
            max-width: 400px;
            padding: 10px 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        #stats {
            font-size: 1.1rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin: 0;
        }

        input[type=range] {
            width: 100%;
        }
    </style>
</head>

<body>
    <h1>Forest Fire Simulator</h1>

    <canvas id="fireCanvas" width="960" height="540"></canvas>

    <div id="stats">Trees: 0 | Density: 0%</div>

    <button id="fullscreenBtn">Fullscreen â›¶</button>
    <button id="resetBtn">Reset</button>

    <div class="controls-container">
        <!-- Growth Rate -->
        <div class="control-group">
            <div class="control-label-row">
                <label for="growthRate">Growth Speed (Trees/sec):</label>
                <span id="growthVal">50</span>
            </div>
            <input type="range" id="growthRate" min="1" max="10000" step="100" value="50">
        </div>

        <!-- Regrowth Delay -->
        <div class="control-group">
            <div class="control-label-row">
                <label for="regrowthDelay">Regrowth Delay (seconds):</label>
                <span id="delayVal">10</span>
            </div>
            <input type="range" id="regrowthDelay" min="0" max="1000" step="1" value="10">
        </div>

        <!-- Fire Trigger -->
        <div class="control-group">
            <div class="control-label-row">
                <label for="fireTrigger">Fire Trigger (Density %):</label>
                <span id="triggerVal">20%</span>
            </div>
            <input type="range" id="fireTrigger" min="1" max="100" step="1" value="20">
        </div>

        <!-- Lightning Timer -->
        <div class="control-group">
            <div class="control-label-row">
                <label for="lightningTimer">Lightning Timer (sec):</label>
                <span id="timerVal">30</span>
            </div>
            <input type="range" id="lightningTimer" min="1" max="120" step="1" value="30">
        </div>
    </div>

    <script type="module">
        import init, { Forest } from './pkg/rust_web_page.js';

        async function run() {
            await init();

            const canvas = document.getElementById('fireCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const size = width * height;

            const forest = Forest.new(width, height);

            // Controls
            const growthSlider = document.getElementById('growthRate');
            const delaySlider = document.getElementById('regrowthDelay');
            const triggerSlider = document.getElementById('fireTrigger');
            const timerSlider = document.getElementById('lightningTimer');
            const resetBtn = document.getElementById('resetBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');

            function updateParams() {
                const growth = parseInt(growthSlider.value);
                const delay = parseInt(delaySlider.value);
                const trigger = parseInt(triggerSlider.value) / 100;
                const timer = parseInt(timerSlider.value);

                document.getElementById('growthVal').innerText = growth;
                document.getElementById('delayVal').innerText = delay;
                document.getElementById('triggerVal').innerText = Math.round(trigger * 100) + '%';
                document.getElementById('timerVal').innerText = timer;

                forest.set_params(growth, trigger, delay, timer);
            }

            growthSlider.addEventListener('input', updateParams);
            delaySlider.addEventListener('input', updateParams);
            triggerSlider.addEventListener('input', updateParams);
            timerSlider.addEventListener('input', updateParams);

            resetBtn.addEventListener('click', () => forest.reset());
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    canvas.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            });

            let tickCount = 0;
            function loop() {
                try {
                    forest.tick();
                    forest.draw(ctx);

                    const count = forest.trees_count();
                    const density = count / size;
                    document.getElementById('stats').innerText = `Trees: ${count} | Density: ${(density * 100).toFixed(1)}%`;

                    if (tickCount < 5) {
                        console.log(`Tick ${tickCount}: Trees=${count}`);
                    }
                    tickCount++;

                    requestAnimationFrame(loop);
                } catch (e) {
                    console.error("Simulation Error:", e);
                    document.getElementById('stats').innerText = "Simulation Error: Check Console";
                    document.getElementById('stats').style.color = "red";
                }
            }

            updateParams();
            loop();
        }

        run();
    </script>
</body>

</html>